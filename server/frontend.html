<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Derivatives Analytics - React</title>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&family=IBM+Plex+Mono:wght@500;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'IBM Plex Sans', sans-serif;
            background: linear-gradient(135deg, #0a0e27 0%, #1a1d3a 50%, #0f1228 100%);
            color: #e8eaf6;
            min-height: 100vh;
            padding: 2rem;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        h1 {
            font-size: 3rem; text-align: center;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            margin-bottom: 2rem; font-weight: 700;
        }
        .subtitle { text-align: center; color: #9ca3af; margin-bottom: 2rem; font-size: 1.1rem; }
        .auth-bar {
            display: flex; justify-content: flex-end; align-items: center;
            gap: 1rem; margin-bottom: 1rem; padding: 0 0.5rem;
        }
        .auth-status {
            font-size: 0.875rem; color: #9ca3af;
            display: flex; align-items: center; gap: 0.5rem;
        }
        .auth-status .dot {
            width: 8px; height: 8px; border-radius: 50%;
        }
        .auth-status .dot.connected { background: #10b981; }
        .auth-status .dot.disconnected { background: #ef4444; }
        .auth-button {
            padding: 0.5rem 1rem; border-radius: 8px; border: none;
            font-size: 0.875rem; font-weight: 600; cursor: pointer;
            transition: all 0.2s;
        }
        .auth-button.login {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }
        .auth-button.logout {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.5);
            color: #ef4444;
        }
        .auth-button:hover { opacity: 0.9; transform: translateY(-1px); }
        .search-box {
            max-width: 600px; margin: 0 auto 2rem;
            background: rgba(255,255,255,0.05); padding: 1.5rem;
            border-radius: 16px; border: 1px solid rgba(255,255,255,0.1);
        }
        .search-label {
            display: block; margin-bottom: 0.5rem; font-size: 0.875rem;
            color: #9ca3af; font-weight: 600; text-transform: uppercase;
        }
        .api-info {
            background: rgba(255, 165, 0, 0.1); border: 1px solid rgba(255, 165, 0, 0.3);
            border-radius: 8px; padding: 0.75rem; margin-bottom: 1rem;
            font-size: 0.875rem; color: #fbbf24;
        }
        .api-info.connected {
            background: rgba(16, 185, 129, 0.1); border-color: rgba(16, 185, 129, 0.3);
            color: #10b981;
        }
        .api-info a { color: inherit; text-decoration: underline; }
        .api-info ol { margin: 0.5rem 0 0 1.5rem; padding: 0; }
        .search-input-group { display: flex; gap: 0.75rem; }
        .search-input {
            flex: 1; padding: 0.875rem 1rem;
            background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.2);
            border-radius: 10px; color: #fff; font-size: 1rem; outline: none;
        }
        .search-input::placeholder { color: rgba(255,255,255,0.5); }
        .search-button {
            padding: 0.875rem 1.5rem;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            border: none; border-radius: 10px; color: #fff;
            font-size: 1rem; font-weight: 600; cursor: pointer; min-width: 120px;
        }
        .search-button:disabled { background: #555; cursor: not-allowed; }
        .stock-result {
            margin-top: 1rem; padding: 1rem;
            background: rgba(99, 102, 241, 0.1); border-radius: 10px;
            border: 1px solid rgba(99, 102, 241, 0.3);
            display: flex; justify-content: space-between; align-items: center;
        }
        .data-source-badge {
            font-size: 0.7rem; padding: 0.2rem 0.5rem;
            border-radius: 4px; margin-left: 0.5rem;
            vertical-align: middle;
        }
        .data-source-badge.live {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }
        .data-source-badge.demo {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
        }
        .tabs {
            display: flex; gap: 1rem; justify-content: center;
            margin-bottom: 2rem; border-bottom: 1px solid rgba(255,255,255,0.1);
            padding-bottom: 1rem;
        }
        .tab {
            padding: 0.875rem 2rem; background: rgba(255,255,255,0.05);
            border: none; border-radius: 12px; color: #fff;
            font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease;
        }
        .tab.active { background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); }
        .tab:disabled { opacity: 0.4; cursor: not-allowed; }
        .chart-container {
            background: rgba(255,255,255,0.03); border-radius: 20px;
            padding: 2rem; border: 1px solid rgba(255,255,255,0.1);
        }
        .accordion-item {
            margin-bottom: 1rem; border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px; overflow: hidden; background: rgba(255,255,255,0.02);
        }
        .accordion-header {
            padding: 1rem 1.5rem; cursor: pointer;
            display: flex; align-items: center; gap: 1rem;
            background: rgba(255,255,255,0.03); transition: background 0.2s;
        }
        .accordion-header:hover { background: rgba(255,255,255,0.05); }
        .accordion-icon {
            font-size: 1.25rem; color: #6366f1; transition: transform 0.3s;
        }
        .accordion-icon.open { transform: rotate(90deg); }
        .accordion-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease; }
        .accordion-content.open { max-height: 10000px; }
        table { width: 100%; border-collapse: collapse; font-size: 0.875rem; }
        thead tr:first-child { background: rgba(99, 102, 241, 0.1); border-bottom: 2px solid rgba(99, 102, 241, 0.3); }
        th { padding: 0.75rem; text-align: center; font-weight: 600; }
        tbody tr { border-bottom: 1px solid rgba(255,255,255,0.05); transition: background 0.2s; }
        tbody tr:hover { background: rgba(255,255,255,0.03); }
        tbody tr.atm { background: rgba(99, 102, 241, 0.05); }
        td { padding: 0.5rem; text-align: center; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem; }
        .panel { background: rgba(255,255,255,0.03); border-radius: 20px; padding: 2rem; border: 1px solid rgba(255,255,255,0.1); }
        .panel h2 { font-size: 1.5rem; margin-bottom: 1.5rem; font-weight: 600; }
        .input-group { margin-bottom: 1.25rem; }
        .input-label {
            display: block; margin-bottom: 0.5rem; font-size: 0.875rem;
            color: #9ca3af; font-weight: 500; text-transform: uppercase;
        }
        .input-field {
            width: 100%; padding: 0.875rem 1rem;
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
            border-radius: 10px; color: #e8eaf6; font-size: 1rem; outline: none;
        }
        .result-box {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            border-radius: 16px; padding: 2rem; margin-bottom: 2rem; text-align: center;
        }
        .result-label { font-size: 0.875rem; color: rgba(255,255,255,0.8); margin-bottom: 0.5rem; text-transform: uppercase; }
        .result-value { font-size: 3rem; font-weight: 700; font-family: 'IBM Plex Mono', monospace; }
        canvas { max-height: 350px; }
        .error-message {
            background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 8px; padding: 1rem; color: #ef4444; margin-top: 1rem;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // API Configuration
        // Served from the same origin as the API server, so use empty string
        const API_BASE = '';

        const futuresSymbols = ['ES', 'NQ', 'YM', 'RTY', 'CL', 'GC', 'SI', 'NG', 'ZB', 'ZN', 'ZC', 'ZS', 'ZW'];

        const normalCDF = (x) => {
            const t = 1 / (1 + 0.2316419 * Math.abs(x));
            const d = 0.3989423 * Math.exp(-x * x / 2);
            const prob = d * t * (0.3193815 + t * (-0.3565638 + t * (1.781478 + t * (-1.821256 + t * 1.330274))));
            return x > 0 ? 1 - prob : prob;
        };

        const blackScholes = (S, K, T, r, sigma, type = 'call') => {
            const d1 = (Math.log(S / K) + (r + sigma * sigma / 2) * T) / (sigma * Math.sqrt(T));
            const d2 = d1 - sigma * Math.sqrt(T);
            return type === 'call'
                ? S * normalCDF(d1) - K * Math.exp(-r * T) * normalCDF(d2)
                : K * Math.exp(-r * T) * normalCDF(-d2) - S * normalCDF(-d1);
        };

        const futuresPrice = (S, r, q, T) => S * Math.exp((r - q) * T);

        // API helper functions
        async function checkAuthStatus() {
            try {
                const response = await fetch(`${API_BASE}/auth/status`, {
                    credentials: 'include'
                });
                if (!response.ok) throw new Error('Server not reachable');
                return await response.json();
            } catch (error) {
                console.log('Auth check failed:', error.message);
                return { authenticated: false, serverError: true, reason: error.message };
            }
        }

        async function fetchQuote(symbol) {
            const response = await fetch(`${API_BASE}/api/quote/${symbol}`, {
                credentials: 'include'
            });
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.message || 'Failed to fetch quote');
            }
            return await response.json();
        }

        async function fetchOptionsChain(symbol) {
            const response = await fetch(`${API_BASE}/api/options/${symbol}?strikeCount=25&includeUnderlyingQuote=true`, {
                credentials: 'include'
            });
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.message || 'Failed to fetch options chain');
            }
            return await response.json();
        }

        async function logout() {
            try {
                await fetch(`${API_BASE}/auth/logout`, {
                    method: 'POST',
                    credentials: 'include'
                });
            } catch (error) {
                console.error('Logout error:', error);
            }
        }

        // Demo data fallback
        function getDemoData(symbol) {
            const prices = { AAPL: 175.43, TSLA: 248.50, MSFT: 378.91, GOOGL: 140.23, AMZN: 178.35, NVDA: 505.48, META: 484.03, SPY: 512.44, QQQ: 438.15 };
            const price = prices[symbol] || 100 + Math.random() * 100;
            const change = (Math.random() - 0.5) * 10;
            return { price, change };
        }

        function getNext5Fridays() {
            const fridays = [];
            const today = new Date();
            let daysUntilFriday = (5 - today.getDay() + 7) % 7 || 7;

            for (let i = 0; i < 5; i++) {
                const friday = new Date(today);
                friday.setDate(today.getDate() + daysUntilFriday + (i * 7));
                const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                fridays.push({
                    date: friday,
                    formatted: `${months[friday.getMonth()]} ${friday.getDate()}, ${friday.getFullYear()}`,
                    dateString: friday.toISOString().split('T')[0]
                });
            }
            return fridays;
        }

        // Parse Schwab expiration date format "2024-02-09:5" -> { date, daysToExp }
        function parseExpirationKey(key) {
            const [dateStr, daysStr] = key.split(':');
            return {
                dateString: dateStr,
                daysToExpiry: parseInt(daysStr),
                formatted: formatDateString(dateStr)
            };
        }

        function formatDateString(dateStr) {
            const date = new Date(dateStr + 'T00:00:00');
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            return `${months[date.getMonth()]} ${date.getDate()}, ${date.getFullYear()}`;
        }

        // Component for real options data from Schwab
        function RealOptionsAccordionItem({ expirationKey, calls, puts, spotPrice }) {
            const [isOpen, setIsOpen] = useState(false);
            const { formatted, daysToExpiry } = parseExpirationKey(expirationKey);

            // Get all strikes from calls and puts
            const allStrikes = new Set([
                ...Object.keys(calls || {}),
                ...Object.keys(puts || {})
            ]);
            const strikes = Array.from(allStrikes).map(Number).sort((a, b) => a - b);

            return (
                <div className="accordion-item">
                    <div className="accordion-header" onClick={() => setIsOpen(!isOpen)}>
                        <div className={`accordion-icon ${isOpen ? 'open' : ''}`}>▶</div>
                        <div>
                            <div style={{ fontSize: '1.125rem', fontWeight: '600' }}>{formatted}</div>
                            <div style={{ fontSize: '0.875rem', color: '#9ca3af', marginTop: '0.25rem' }}>
                                {daysToExpiry} days to expiration | {strikes.length} strikes
                            </div>
                        </div>
                    </div>
                    <div className={`accordion-content ${isOpen ? 'open' : ''}`}>
                        <table>
                            <thead>
                                <tr>
                                    <th colSpan="4" style={{ color: '#10b981', borderRight: '1px solid rgba(255,255,255,0.1)' }}>CALLS</th>
                                    <th style={{ borderLeft: '1px solid rgba(255,255,255,0.1)', borderRight: '1px solid rgba(255,255,255,0.1)' }}>STRIKE</th>
                                    <th colSpan="4" style={{ color: '#ef4444', borderLeft: '1px solid rgba(255,255,255,0.1)' }}>PUTS</th>
                                </tr>
                                <tr style={{ background: 'rgba(255,255,255,0.02)' }}>
                                    <th style={{ color: '#9ca3af', fontSize: '0.75rem', fontWeight: '500' }}>Bid</th>
                                    <th style={{ color: '#9ca3af', fontSize: '0.75rem', fontWeight: '500' }}>Ask</th>
                                    <th style={{ color: '#9ca3af', fontSize: '0.75rem', fontWeight: '500' }}>Delta</th>
                                    <th style={{ color: '#9ca3af', fontSize: '0.75rem', fontWeight: '500', borderRight: '1px solid rgba(255,255,255,0.1)' }}>IV</th>
                                    <th style={{ color: '#9ca3af', fontSize: '0.75rem', fontWeight: '500', borderLeft: '1px solid rgba(255,255,255,0.1)', borderRight: '1px solid rgba(255,255,255,0.1)' }}>Price</th>
                                    <th style={{ color: '#9ca3af', fontSize: '0.75rem', fontWeight: '500', borderLeft: '1px solid rgba(255,255,255,0.1)' }}>Bid</th>
                                    <th style={{ color: '#9ca3af', fontSize: '0.75rem', fontWeight: '500' }}>Ask</th>
                                    <th style={{ color: '#9ca3af', fontSize: '0.75rem', fontWeight: '500' }}>Delta</th>
                                    <th style={{ color: '#9ca3af', fontSize: '0.75rem', fontWeight: '500' }}>IV</th>
                                </tr>
                            </thead>
                            <tbody>
                                {strikes.map(strike => {
                                    const call = calls?.[strike]?.[0] || {};
                                    const put = puts?.[strike]?.[0] || {};
                                    const isATM = Math.abs(strike - spotPrice) < (spotPrice * 0.02);
                                    const callITM = spotPrice > strike;
                                    const putITM = spotPrice < strike;

                                    return (
                                        <tr key={strike} className={isATM ? 'atm' : ''}>
                                            <td style={{ color: callITM ? '#10b981' : '#6b7280' }}>
                                                ${(call.bid || 0).toFixed(2)}
                                            </td>
                                            <td style={{ color: callITM ? '#10b981' : '#6b7280' }}>
                                                ${(call.ask || 0).toFixed(2)}
                                            </td>
                                            <td style={{ color: '#9ca3af', fontSize: '0.75rem' }}>
                                                {call.delta ? call.delta.toFixed(2) : '-'}
                                            </td>
                                            <td style={{ color: '#9ca3af', fontSize: '0.75rem', borderRight: '1px solid rgba(255,255,255,0.1)' }}>
                                                {call.volatility ? (call.volatility * 100).toFixed(1) + '%' : '-'}
                                            </td>
                                            <td style={{ fontWeight: isATM ? '700' : '500', borderLeft: '1px solid rgba(255,255,255,0.1)', borderRight: '1px solid rgba(255,255,255,0.1)' }}>
                                                ${strike.toFixed(2)}
                                            </td>
                                            <td style={{ color: putITM ? '#ef4444' : '#6b7280', borderLeft: '1px solid rgba(255,255,255,0.1)' }}>
                                                ${(put.bid || 0).toFixed(2)}
                                            </td>
                                            <td style={{ color: putITM ? '#ef4444' : '#6b7280' }}>
                                                ${(put.ask || 0).toFixed(2)}
                                            </td>
                                            <td style={{ color: '#9ca3af', fontSize: '0.75rem' }}>
                                                {put.delta ? put.delta.toFixed(2) : '-'}
                                            </td>
                                            <td style={{ color: '#9ca3af', fontSize: '0.75rem' }}>
                                                {put.volatility ? (put.volatility * 100).toFixed(1) + '%' : '-'}
                                            </td>
                                        </tr>
                                    );
                                })}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        }

        // Component for demo/calculated options data
        function DemoAccordionItem({ friday, spotPrice }) {
            const [isOpen, setIsOpen] = useState(false);
            const daysToExpiry = Math.ceil((friday.date - new Date()) / (1000 * 60 * 60 * 24));
            const T = daysToExpiry / 365;
            const strikeInterval = Math.max(1, Math.round(spotPrice * 0.02));

            const strikes = [];
            for (let i = -12; i <= 12; i++) {
                strikes.push(Math.round((spotPrice + i * strikeInterval) * 100) / 100);
            }

            return (
                <div className="accordion-item">
                    <div className="accordion-header" onClick={() => setIsOpen(!isOpen)}>
                        <div className={`accordion-icon ${isOpen ? 'open' : ''}`}>▶</div>
                        <div>
                            <div style={{ fontSize: '1.125rem', fontWeight: '600' }}>{friday.formatted}</div>
                            <div style={{ fontSize: '0.875rem', color: '#9ca3af', marginTop: '0.25rem' }}>
                                {daysToExpiry} days to expiration
                            </div>
                        </div>
                    </div>
                    <div className={`accordion-content ${isOpen ? 'open' : ''}`}>
                        <table>
                            <thead>
                                <tr>
                                    <th colSpan="2" style={{ color: '#10b981', borderRight: '1px solid rgba(255,255,255,0.1)' }}>CALLS</th>
                                    <th style={{ borderLeft: '1px solid rgba(255,255,255,0.1)', borderRight: '1px solid rgba(255,255,255,0.1)' }}>STRIKE</th>
                                    <th colSpan="2" style={{ color: '#ef4444', borderLeft: '1px solid rgba(255,255,255,0.1)' }}>PUTS</th>
                                </tr>
                                <tr style={{ background: 'rgba(255,255,255,0.02)' }}>
                                    <th style={{ color: '#9ca3af', fontSize: '0.75rem', fontWeight: '500' }}>Bid</th>
                                    <th style={{ color: '#9ca3af', fontSize: '0.75rem', fontWeight: '500', borderRight: '1px solid rgba(255,255,255,0.1)' }}>Ask</th>
                                    <th style={{ color: '#9ca3af', fontSize: '0.75rem', fontWeight: '500', borderLeft: '1px solid rgba(255,255,255,0.1)', borderRight: '1px solid rgba(255,255,255,0.1)' }}>Price</th>
                                    <th style={{ color: '#9ca3af', fontSize: '0.75rem', fontWeight: '500', borderLeft: '1px solid rgba(255,255,255,0.1)' }}>Bid</th>
                                    <th style={{ color: '#9ca3af', fontSize: '0.75rem', fontWeight: '500' }}>Ask</th>
                                </tr>
                            </thead>
                            <tbody>
                                {strikes.map(strike => {
                                    const baseIV = 0.25 + Math.abs(strike - spotPrice) / spotPrice * 0.1;
                                    const callPrice = blackScholes(spotPrice, strike, T, 0.05, baseIV, 'call');
                                    const putPrice = blackScholes(spotPrice, strike, T, 0.05, baseIV, 'put');
                                    const callSpread = Math.max(0.05, callPrice * 0.03);
                                    const putSpread = Math.max(0.05, putPrice * 0.03);
                                    const isATM = Math.abs(strike - spotPrice) < strikeInterval;
                                    const callITM = spotPrice > strike;
                                    const putITM = spotPrice < strike;

                                    return (
                                        <tr key={strike} className={isATM ? 'atm' : ''}>
                                            <td style={{ color: callITM ? '#10b981' : '#6b7280' }}>
                                                ${Math.max(0, callPrice - callSpread / 2).toFixed(2)}
                                            </td>
                                            <td style={{ color: callITM ? '#10b981' : '#6b7280', borderRight: '1px solid rgba(255,255,255,0.1)' }}>
                                                ${(callPrice + callSpread / 2).toFixed(2)}
                                            </td>
                                            <td style={{ fontWeight: isATM ? '700' : '500', borderLeft: '1px solid rgba(255,255,255,0.1)', borderRight: '1px solid rgba(255,255,255,0.1)' }}>
                                                ${strike.toFixed(2)}
                                            </td>
                                            <td style={{ color: putITM ? '#ef4444' : '#6b7280', borderLeft: '1px solid rgba(255,255,255,0.1)' }}>
                                                ${Math.max(0, putPrice - putSpread / 2).toFixed(2)}
                                            </td>
                                            <td style={{ color: putITM ? '#ef4444' : '#6b7280' }}>
                                                ${(putPrice + putSpread / 2).toFixed(2)}
                                            </td>
                                        </tr>
                                    );
                                })}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        }

        function OptionsTab({ spotPrice, optionsData, isLiveData }) {
            if (!spotPrice) {
                return (
                    <div className="chart-container">
                        <h2 style={{ marginBottom: '1.5rem' }}>Options Chain</h2>
                        <div style={{ color: '#9ca3af', textAlign: 'center', padding: '2rem' }}>
                            Enter a stock symbol and click Search to view the options chain
                        </div>
                    </div>
                );
            }

            // If we have real options data from Schwab
            if (isLiveData && optionsData && (optionsData.callExpDateMap || optionsData.putExpDateMap)) {
                const expirations = Object.keys(optionsData.callExpDateMap || optionsData.putExpDateMap || {});

                return (
                    <div className="chart-container">
                        <h2 style={{ marginBottom: '1.5rem' }}>
                            Options Chain
                            <span className="data-source-badge live">LIVE DATA</span>
                        </h2>
                        <div style={{ maxWidth: '1200px', margin: '0 auto' }}>
                            {expirations.slice(0, 10).map((expKey) => (
                                <RealOptionsAccordionItem
                                    key={expKey}
                                    expirationKey={expKey}
                                    calls={optionsData.callExpDateMap?.[expKey]}
                                    puts={optionsData.putExpDateMap?.[expKey]}
                                    spotPrice={spotPrice}
                                />
                            ))}
                        </div>
                    </div>
                );
            }

            // Fallback to demo/calculated data
            return (
                <div className="chart-container">
                    <h2 style={{ marginBottom: '1.5rem' }}>
                        Options Chain
                        <span className="data-source-badge demo">DEMO DATA</span>
                    </h2>
                    <div style={{ maxWidth: '1000px', margin: '0 auto' }}>
                        {getNext5Fridays().map((friday, i) => (
                            <DemoAccordionItem key={i} friday={friday} spotPrice={spotPrice} />
                        ))}
                    </div>
                </div>
            );
        }

        function FuturesTab({ params, onChange }) {
            const chartRef = useRef(null);
            const chartInstance = useRef(null);
            const [data, setData] = useState({ theoreticalPrice: 0, basis: 0, costOfCarry: 0 });

            useEffect(() => {
                const { spotPrice, riskFreeRate, dividendYield, timeToExpiry, contractSize } = params;
                const theoretical = futuresPrice(spotPrice, riskFreeRate / 100, dividendYield / 100, timeToExpiry);
                setData({
                    theoreticalPrice: theoretical,
                    basis: theoretical - spotPrice,
                    costOfCarry: (riskFreeRate / 100 - dividendYield / 100) * spotPrice * timeToExpiry
                });

                if (chartRef.current && window.Chart) {
                    const chartData = [];
                    for (let i = 0; i <= 30; i++) {
                        const t = timeToExpiry * (1 - i / 30);
                        chartData.push({
                            days: Math.round(t * 365),
                            futures: futuresPrice(spotPrice, riskFreeRate / 100, dividendYield / 100, t),
                            spot: spotPrice
                        });
                    }

                    if (chartInstance.current) chartInstance.current.destroy();

                    chartInstance.current = new window.Chart(chartRef.current, {
                        type: 'line',
                        data: {
                            labels: chartData.reverse().map(d => d.days),
                            datasets: [
                                { label: 'Futures', data: chartData.map(d => d.futures), borderColor: '#6366f1', tension: 0.1 },
                                { label: 'Spot', data: chartData.map(d => d.spot), borderColor: '#8b5cf6', borderDash: [5, 5], tension: 0.1 }
                            ]
                        },
                        options: {
                            responsive: true,
                            plugins: { legend: { labels: { color: '#9ca3af' } } },
                            scales: {
                                x: { ticks: { color: '#9ca3af' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                                y: { ticks: { color: '#9ca3af' }, grid: { color: 'rgba(255,255,255,0.1)' } }
                            }
                        }
                    });
                }
            }, [params]);

            return (
                <div>
                    <div className="grid-2">
                        <div className="panel">
                            <h2>Futures Parameters</h2>
                            {[
                                { label: 'Spot Price ($)', field: 'spotPrice', step: '1' },
                                { label: 'Risk-Free Rate (%)', field: 'riskFreeRate', step: '0.1' },
                                { label: 'Dividend Yield (%)', field: 'dividendYield', step: '0.1' },
                                { label: 'Time to Expiry (years)', field: 'timeToExpiry', step: '0.01' },
                                { label: 'Contract Size', field: 'contractSize', step: '1' }
                            ].map(({ label, field, step }) => (
                                <div className="input-group" key={field}>
                                    <label className="input-label">{label}</label>
                                    <input type="number" className="input-field" step={step}
                                        value={params[field]}
                                        onChange={(e) => onChange(field, parseFloat(e.target.value) || 0)}
                                    />
                                </div>
                            ))}
                        </div>
                        <div className="panel">
                            <h2>Pricing Analysis</h2>
                            <div className="result-box">
                                <div className="result-label">Theoretical Futures Price</div>
                                <div className="result-value">${data.theoreticalPrice.toFixed(2)}</div>
                            </div>
                            {[
                                { label: 'Basis', value: data.basis, color: data.basis > 0 ? '#10b981' : '#ef4444' },
                                { label: 'Cost of Carry', value: data.costOfCarry, color: '#8b5cf6' },
                                { label: 'Contract Value', value: data.theoreticalPrice * params.contractSize, color: '#06b6d4' }
                            ].map(({ label, value, color }) => (
                                <div key={label} style={{ background: 'rgba(255,255,255,0.05)', borderRadius: '12px', padding: '1.25rem', marginBottom: '1rem' }}>
                                    <div style={{ fontSize: '0.875rem', color: '#9ca3af', marginBottom: '0.75rem', textTransform: 'uppercase' }}>{label}</div>
                                    <div style={{ fontSize: '1.75rem', fontWeight: '700', color, fontFamily: '"IBM Plex Mono", monospace' }}>${value.toFixed(2)}</div>
                                </div>
                            ))}
                        </div>
                    </div>
                    <div className="chart-container" style={{ marginTop: '2rem' }}>
                        <h2 style={{ marginBottom: '1.5rem' }}>Price Convergence</h2>
                        <canvas ref={chartRef}></canvas>
                    </div>
                </div>
            );
        }

        function App() {
            const [tab, setTab] = useState('options');
            const [symbol, setSymbol] = useState('');
            const [loading, setLoading] = useState(false);
            const [stock, setStock] = useState(null);
            const [spotPrice, setSpotPrice] = useState(0);
            const [optionsData, setOptionsData] = useState(null);
            const [isLiveData, setIsLiveData] = useState(false);
            const [futuresEnabled, setFuturesEnabled] = useState(false);
            const [futuresParams, setFuturesParams] = useState({
                spotPrice: 100, riskFreeRate: 5, dividendYield: 2, timeToExpiry: 0.5, contractSize: 100
            });
            const [authStatus, setAuthStatus] = useState({ authenticated: false, checking: true });
            const [error, setError] = useState(null);

            // Check authentication status on load
            useEffect(() => {
                async function checkAuth() {
                    const status = await checkAuthStatus();
                    setAuthStatus({ ...status, checking: false });
                }
                checkAuth();
            }, []);

            const handleLogin = () => {
                window.open(`${API_BASE}/auth/login`, '_blank', 'width=600,height=700');
                // Poll for auth status changes
                const pollInterval = setInterval(async () => {
                    const status = await checkAuthStatus();
                    if (status.authenticated) {
                        setAuthStatus({ ...status, checking: false });
                        clearInterval(pollInterval);
                    }
                }, 2000);
                // Stop polling after 5 minutes
                setTimeout(() => clearInterval(pollInterval), 300000);
            };

            const handleLogout = async () => {
                await logout();
                setAuthStatus({ authenticated: false, checking: false });
                setIsLiveData(false);
            };

            const handleSearch = async () => {
                if (!symbol.trim()) return alert('Please enter a stock symbol');
                setLoading(true);
                setError(null);
                setOptionsData(null);

                const upperSymbol = symbol.toUpperCase();
                let price, change, usedLiveData = false;

                // Try to fetch from Schwab API if authenticated
                if (authStatus.authenticated) {
                    try {
                        // Fetch quote
                        const quoteData = await fetchQuote(upperSymbol);
                        const symbolData = quoteData[upperSymbol];

                        if (symbolData && symbolData.quote) {
                            price = symbolData.quote.lastPrice;
                            change = symbolData.quote.netChange;
                            usedLiveData = true;
                        }

                        // Fetch options chain
                        try {
                            const options = await fetchOptionsChain(upperSymbol);
                            setOptionsData(options);
                        } catch (optErr) {
                            console.warn('Options fetch failed:', optErr.message);
                            // Continue without options data - will use demo
                        }
                    } catch (err) {
                        console.warn('Quote fetch failed:', err.message);
                        setError(`API Error: ${err.message}. Falling back to demo data.`);
                        // Fall through to demo data
                    }
                }

                // Fall back to demo data if needed
                if (!usedLiveData) {
                    const demo = getDemoData(upperSymbol);
                    price = demo.price;
                    change = demo.change;
                }

                setStock({
                    symbol: upperSymbol,
                    price,
                    change,
                    changePercent: ((change / price) * 100).toFixed(2) + '%'
                });
                setSpotPrice(price);
                setFuturesParams(p => ({ ...p, spotPrice: price }));
                setIsLiveData(usedLiveData);

                const isFutures = futuresSymbols.some(f => upperSymbol.startsWith(f));
                setFuturesEnabled(isFutures);
                if (!isFutures && tab === 'futures') setTab('options');

                setLoading(false);
            };

            return (
                <div className="container">
                    <h1>Derivatives Analytics</h1>

                    <div className="auth-bar">
                        {authStatus.checking ? (
                            <span className="auth-status">Checking connection...</span>
                        ) : authStatus.serverError ? (
                            <span className="auth-status">
                                <span className="dot disconnected"></span>
                                Server offline - using demo data
                            </span>
                        ) : authStatus.authenticated ? (
                            <>
                                <span className="auth-status">
                                    <span className="dot connected"></span>
                                    Connected to Schwab API
                                </span>
                                <button className="auth-button logout" onClick={handleLogout}>
                                    Logout
                                </button>
                            </>
                        ) : (
                            <>
                                <span className="auth-status">
                                    <span className="dot disconnected"></span>
                                    Not connected
                                </span>
                                <button className="auth-button login" onClick={handleLogin}>
                                    Login to Schwab
                                </button>
                            </>
                        )}
                    </div>

                    <div className="search-box">
                        <label className="search-label">Stock Symbol</label>
                        {!authStatus.authenticated && !authStatus.serverError && (
                            <div className="api-info">
                                <strong>Schwab API Setup:</strong> To get real-time options data:
                                <ol>
                                    <li>Start the backend: <code>cd server && npm install && npm start</code></li>
                                    <li>Click "Login to Schwab" above</li>
                                    <li>Complete OAuth authentication</li>
                                </ol>
                                Currently using demo/calculated data.
                            </div>
                        )}
                        {authStatus.authenticated && (
                            <div className="api-info connected">
                                Connected to Schwab API - Real-time market data enabled
                            </div>
                        )}
                        <div className="search-input-group">
                            <input className="search-input" placeholder="e.g., AAPL, TSLA, MSFT"
                                value={symbol} onChange={(e) => setSymbol(e.target.value.toUpperCase())}
                                onKeyPress={(e) => e.key === 'Enter' && handleSearch()}
                            />
                            <button className="search-button" onClick={handleSearch} disabled={loading}>
                                {loading ? 'Loading...' : 'Search'}
                            </button>
                        </div>

                        {error && (
                            <div className="error-message">{error}</div>
                        )}

                        {stock && (
                            <div className="stock-result">
                                <div>
                                    <div style={{ fontSize: '1.25rem', fontWeight: '700' }}>
                                        {stock.symbol}
                                        <span className={`data-source-badge ${isLiveData ? 'live' : 'demo'}`}>
                                            {isLiveData ? 'LIVE' : 'DEMO'}
                                        </span>
                                    </div>
                                    <div style={{ fontSize: '0.875rem', color: '#9ca3af' }}>Current Price</div>
                                </div>
                                <div style={{ textAlign: 'right' }}>
                                    <div style={{ fontSize: '1.75rem', fontWeight: '700', color: '#6366f1' }}>${stock.price.toFixed(2)}</div>
                                    <div style={{ fontSize: '0.875rem', fontWeight: '600', color: stock.change >= 0 ? '#10b981' : '#ef4444' }}>
                                        {stock.change >= 0 ? '+' : ''}{stock.change.toFixed(2)} ({stock.changePercent})
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>

                    <div className="tabs">
                        <button className={`tab ${tab === 'options' ? 'active' : ''}`} onClick={() => setTab('options')}>
                            Options Analyzer
                        </button>
                        <button className={`tab ${tab === 'futures' ? 'active' : ''}`}
                            onClick={() => futuresEnabled && setTab('futures')} disabled={!futuresEnabled}>
                            Futures Pricing
                        </button>
                    </div>

                    {tab === 'options' && <OptionsTab spotPrice={spotPrice} optionsData={optionsData} isLiveData={isLiveData} />}
                    {tab === 'futures' && <FuturesTab params={futuresParams} onChange={(f, v) => setFuturesParams(p => ({ ...p, [f]: v }))} />}
                </div>
            );
        }

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
